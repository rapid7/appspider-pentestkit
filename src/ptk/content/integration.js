/* Author: Denis Podgurskii */

(function () {
    if (window.ptk_integration || typeof browser === typeof undefined) return

    class ptk_integration {
        constructor() {
            this.origin = location.href
            this.eventName = "ptk_extension_event"
            this.addListeners()
        }

        addListeners() {
            this.windowListener = this.windowListener.bind(this)
            window.addEventListener("message", this.windowListener)
        }

        windowListener(e) {
            let message = e.data;
            if (message.channel == 'ptk_messages_channel') {
                if (this["msg_" + message.command]) {
                    this["msg_" + message.command](message.params).then(function (response) {
                        let detail = Object.assign({}, { event: message.command }, response)
                        try {
                            detail = cloneInto(detail, e.source.document) //FF fix
                        } catch (e) { }
                        document.dispatchEvent(new CustomEvent(this.eventName, { detail: detail }))
                    }.bind(this))
                }
            }
            if (message.channel == 'ptk_messages_channel_xss') {
                alert(message.command)
            }
        }

        msg_init_recording(params) {
            return Promise.resolve({ success: true, result: browser.runtime.getManifest().version })
        }

        msg_start_recording(params) {
            return browser.runtime.sendMessage({
                channel: "ptk_popup2background_recorder",
                type: "start_recording",
                clean_cookie: params.clean_cookie,
                url: params.start_url
            }).catch(e => e)
        }

        msg_stop_recording(params) {
            return browser.runtime.sendMessage({
                channel: "ptk_popup2background_recorder",
                type: "stop_recording"
            }).catch(e => e)
        }

        msg_export_recording(params) {
            return browser.runtime.sendMessage({
                channel: "ptk_popup2background_recorder",
                type: "export_recording",
                settings: params.settings
            }).catch(e => e)
        }

        msg_reset_recording(params) {
            return browser.runtime.sendMessage({
                channel: "ptk_popup2background_recorder",
                type: "reset_recording"
            }).catch(e => e)
        }
    }

    window.ptk_integration = new ptk_integration()

})()


