import React, {
    useEffect,
    useState,
} from 'react';

import {
    Button,
    Textarea,
} from 'rapid7-ui';

import { ptk_controller_macro } from '../browser/assets/js/controller/macro';

const controller = new ptk_controller_macro({
    format: 'xml',
});

const useMacroRecorder = () => {
    const [macro, setMacro] = useState('');
    const [url, setUrl] = useState('');

    useEffect(() => {
        document.addEventListener('export', () => {
            setMacro(controller.export());
        });

        browser.runtime.onMessage.addListener(message => {
            if (message.channel === 'ptk_background2popup_recorder' && message.type === 'recording_completed') {
                controller.recording = message.recording;
                const exportEvt = new Event('export');

                document.dispatchEvent(exportEvt);
            }
        });

        controller.init().then(result => {
            controller.getSettings().then(() => {
                if (result.savedMacro) {
                    setMacro(result.savedMacro);
                } else {
                    const exportEvt = new Event('export');

                    document.dispatchEvent(exportEvt);
                }
            });
        });

        browser.tabs.query({
            currentWindow: true, active: true,
        })
            .then(tabs => {
                const tab = tabs[ 0 ];

                if (tab && !tab.url.startsWith('chrome://')) {
                    setUrl(tab.url);
                }
            });
    }, []);

    return {
        macro,
        url,
    };
};

const Macro = () => {
    const {
        macro,
        url,
    } = useMacroRecorder();

    return (
        <>
            <Button
                className="start_clean_cookie"
                onClick={() => {
                    controller.start(true, url).then(response => {
                        console.log(response);
                    });
                }}
            >
                Start
            </Button>
            <Textarea
                name="recording_output"
                id="recording_output"
                rows="30"
                placeholder="Macro"
                value={macro}
                style={{ width: '100%' }}
            />
        </>
    );
};

export default Macro;
