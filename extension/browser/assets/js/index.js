/* Author: Denis Podgurskii */
'use strict';

$(document).ready(function() {

    $('#reload').click(function() {
        indexController.run();
    });

    $('#activate_btn').click(function() {
        bgProxy.BrowserActions.activateTabsCapturing();
        location.reload();
    });
    $('#deactivate_btn').click(function() {
        bgProxy.BrowserActions.deactivateTabsCapturing();
        location.reload();
    });

    $('.item.clean').click(function() {
        bgProxy.clearTab(bgProxy.activeTab.tabId);
    });

    $('.item.export').click(function() {
        bgProxy.exportTraffic(bgProxy.activeTab.tabId);
    });

    $('#send_to_request').click(function() {
        window.location.href = "requestbuilder.html?frameId=" + $('#details_frameId').val() + '&requestId=' + $('#details_requestId').val() + '&index=' + $('#details_index').val();
    });

    indexController.run();

});

////////////////////////////////////
/* Index controller instance */
////////////////////////////////////
var indexController = {
    _tabObj: {},
    _requestHeaders: {},
    _responseHeaders: {},

    bindPages: function(tab) {
        //console.log(tab);
        this._tabObj = tab;
        this.bindInfo();
        this.bindTechnologies();
        this.bindFrames();
    },

    bindTable: function(id, params) {
        params.paging = false;
        params.ordering = false;
        params.info = false;
        params.searching = false;
        params.sorting = false;

        if ($.fn.dataTable.isDataTable(id)) {
            //console.log('update');
            var table = $(id).DataTable();
            table.clear().rows.add(params.data).draw();
        } else {
            //console.log('new');
            $(id).DataTable(params);
        }
    },

    bindInfo: function() {
        $('#tab_title').text(this._tabObj.tab.title);
        $('#tab_url').text(this._tabObj.tab.url);
    },

    bindWebSocketMessage: function(msg, type) {
        //$('#websocket').text(type + " : " + msg);
        $('#websocket_traffic').val(function(i, text) {
            var text = text + "\r\n";
            text += type + " : " + msg;
            return text;
        });
    },

    bindTechnologies: function() {
        var jsonobj = $.parseJSON(this._tabObj.clientApps);
        var dt = new Array();
        for (var k in jsonobj.apps) {
            dt.push([k, jsonobj.apps[k]]);
        }
        //move to jquery stuff
        var params = {
            "data": dt,
            "columns": [{ title: "Name" }, { title: "Version" }]
        };
        this.bindTable('#tbl_technologies', params);

    },

    bindFrames: function() {
        var dt = new Array();
        //create data source
        for (var fId in this._tabObj.frames) {
            var frame = this._tabObj.frames[fId];
            var i = 0,
                data = {},
                ip = '';
            for (var r in frame) {
                if (i == 0) {
                    ip = frame[r][0].ip ? frame[r][0].ip : '';
                    var parser = document.createElement('a');
                    parser.href = frame[r][0].url;
                    data.frame = frame[r][0].parentFrameId == -1 ? "main" : "iframe";
                    data.url = parser.hostname;
                }
                if (frame[r][0].ip && ip.indexOf(frame[r][0].ip) < 0) ip += ", " + frame[r][0].ip;
                i++;
            }
            dt.push(['', fId, data.frame, data.url, ip]);
        }

        //move to jquery stuff
        var params = {
            "data": dt,
            "columns": [{
                render: function(data, type, row) {
                    return '<i class="expandchild plus square icon big"></i>';
                },
                "className": "expandbtn"

            }, { "visible": false }, { title: "Frame" }, { title: "Url" }, { title: "IP" }]
        };
        this.bindTable('#tbl_frames', params);

        $('.expandchild.plus.icon').click(function() {
            var table = $('#tbl_frames').DataTable(),
                tr = $(this).closest('tr'),
                row = table.row(tr),
                values = table.row($(this).parents('tr')).data();
            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                $(this).removeClass('shown minus');
                $(this).addClass('shown plus');
            } else {
                // Open this row
                row.child('<div style="padding-left: 45px"><table class="ui celled table stackable small fullwidth" id="tbl_frame_' + values[1] + '" >' +
                    '<thead></thead><tbody></tbody></table></div>').show();
                $(this).removeClass('shown plus');
                $(this).addClass('shown minus');
                indexController.bindRequests(values[1]);
            }
        });
        $('.expandchild.plus.icon:first').trigger('click');

    },


    bindRequests: function(index) {
        var dt = new Array();

        var frame = this._tabObj.frames[index];
        for (var r in frame) {
            for (var i in frame[r]) {
                var parser = document.createElement('a');
                parser.href = frame[r][i].url;
                dt.push([i, r, frame[r][i].frameId, parser.hostname, frame[r][i].type, frame[r][i].statusCode ? frame[r][i].statusCode : '',
                    frame[r][i].method, frame[r][i].fromCache ? frame[r][i].fromCache : 'unknown', frame[r][i].ip ? frame[r][i].ip : ''
                ]);
                i++;
            }
        }

        //move to jquery stuff
        var params = {
            "data": dt,
            "columns": [{ "visible": false }, { "visible": false }, { "visible": false }, { title: "Url" }, { title: "Type" }, { title: "Status" }, { title: "Method" }, { title: "Cached" }, { title: "IP" },
                {
                    render: function(data, type, row) {
                        return '<button type="button" class="request_details">Details</button>';
                    }
                }
            ]
        };
        this.bindTable('#tbl_frame_' + index, params);

        $('#tbl_frame_' + index + " tbody tr:first").addClass('active');

        $('.request_details').on('click', function() {
            var table = $(this).closest('table').DataTable(),
                tr = $(this).closest('tr'),
                row = table.row(tr),
                values = table.row($(this).parents('tr')).data();
            indexController.bindRequestDetails(values[0], values[1], values[2]);
            $('.ui.modal').modal('show');
        });

    },

    bindRequestDetails: function(index, requestId, frameId) {
        var $form = $('#details_form');
        $form.form('clear');
        var request = this._tabObj.frames[frameId][requestId][index];
        var obj = {};

        if (request.requestHeaders)
            obj.details_request_headers = request.requestHeaders.map(x => x.name + ": " + x.value).join('\n');
        if (request.requestBody && request.requestBody.formData) {
            var params = Object.keys(request.requestBody.formData).map(function(k) {
                return encodeURIComponent(k) + '=' + encodeURIComponent(request.requestBody.formData[k])
            }).join('&')
            obj.details_request_headers += "\n\n" + params;
        }

        if (request.responseHeaders)
            obj.details_response_headers = request.responseHeaders.map(x => x.name + ": " + x.value).join('\n');


        obj.details_frameId = frameId;
        obj.details_requestId = requestId;
        obj.details_index = index;
        $form.form('set values', obj);
    },

    run: function() {

        if (!bgProxy.BrowserActions.isTabsCapturingActive) {
            $('#activate_message').show();
        } else {
            $('#deactivate_message').show();
        }

        var activeTab = bgProxy.activeTab;
        if (activeTab == null) return;

        var tabObj = bgProxy.getTab(activeTab.tabId);
        this.analyzeHeaders(tabObj);

        chrome.tabs.sendMessage(activeTab.tabId, {
            channel: "ptkPopupToContent",
            type: "init",
            detector: bgProxy.detector,
            dictionary: bgProxy.dictionary,
            runner: bgProxy.runner,
            responseHeaders: JSON.stringify(this._responseHeaders)
        });

    },

    complete: function(tab, request) {
        bgProxy.setTab(tab.id, {
            tab: tab,
            clientApps: request.apps,
            clientHtml: request.html,
            clientScripts: request.scripts
        }, 'clientApps');
        var tabObj = bgProxy.getTab(tab.id);
        if (tabObj != null && typeof tabObj.frames != 'undefined') {

            this.bindPages(tabObj);
        }
    },

    analyzeHeaders: function(tabObj) {
        this._responseHeaders = {};
        if (!tabObj || !tabObj.frames) return;
        for (var fId in tabObj.frames) {
            var frame = tabObj.frames[fId];
            for (var r in frame) {
                // for (var regH in frame[r].requestHeaders) {
                //     var h = frame[r].requestHeaders[regH];
                //     if (h.name in this._requestHeaders) continue;
                //     this._requestHeaders[h.name] = h.value;
                // }
                for (var i in frame[r]) {
                    for (var respH in frame[r][i].responseHeaders) {
                        var h = frame[r][i].responseHeaders[respH];
                        if (h.name in this._responseHeaders) continue;
                        this._responseHeaders[h.name] = h.value;
                    }
                }
            }
        }
    }
};

////////////////////////////////////
/* Chrome runtime events handlers */
////////////////////////////////////
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {

    if (request.channel == "ptkContentToPopup") {
        if (request.type == "complete")
            indexController.complete(sender.tab, request);
        if (request.type == "websocket") {
            var data = request.data;
            indexController.bindWebSocketMessage(data.message, data.type);
        }
    }
    if (request.channel == "ptkBackgroundToPopup" && request.type == "active tab changed") {
        if ($('#reload_on_active').parent().checkbox('is checked')) {
            indexController.run();
        }
    }

    if (request.type == "send") {
        $('#websocket_traffic').val($('#websocket_traffic').val() + request.message);
    }
});