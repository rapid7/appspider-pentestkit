/* Author: Denis Podgurskii */

browser.runtime.onMessage.addListener(function (message, sender, sendResponse) {

    if (message.channel == "ptk_popup2content" && message.type == "init") {
        // HTML
        let html = new XMLSerializer().serializeToString(document)

        // Discard the middle portion of HTML to avoid performance degradation on large pages
        const chunks = []
        const maxCols = 2000
        const maxRows = 3000
        const rows = html.length / maxCols

        for (let i = 0; i < rows; i += 1) {
            if (i < maxRows / 2 || i > rows - maxRows / 2) {
                chunks.push(html.slice(i * maxCols, (i + 1) * maxCols))
            }
        }
        html = chunks.join('\n')

        // CSS rules
        let css = []

        try {
            for (const sheet of Array.from(document.styleSheets)) {
                for (const rules of Array.from(sheet.cssRules)) {
                    css.push(rules.cssText)

                    if (css.length >= 3000) {
                        break
                    }
                }
            }
        } catch (error) {
            // Continue
        }
        css = css.join('\n')

        // Script tags
        const scripts = Array.from(document.scripts)
            .filter(({ src }) => src)
            .map(({ src }) => src)
            .filter((script) => script.indexOf('data:text/javascript;') !== 0)

        // Meta tags
        const meta = Array.from(document.querySelectorAll('meta')).reduce(
            (metas, meta) => {
                const key = meta.getAttribute('name') || meta.getAttribute('property')

                if (key) {
                    metas[key.toLowerCase()] = [meta.getAttribute('content')]
                }

                return metas
            },
            {}
        )

        return Promise.resolve({ html: html, meta: meta, scripts: scripts, css: css })
    }
})





