/* Author: Denis Podgurskii */
import { ptk_controller_requestbuilder } from "./controller/requestbuilder.js"
const controller = new ptk_controller_requestbuilder()


jQuery(function () {

    $(document).on("init_request", function (e, request, formId) {
        if (request && request.requestHeaders) {

            let $form = $('#' + formId + ' #request_form')

            let path = request.method + ' ' + request.url + ' HTTP/1.1'
            let headersStr = path + '\n' + request.requestHeaders.map(x => x.name + ": " + x.value).join('\n')

            if (request?.requestBody?.formData) {
                let params = Object.keys(request.requestBody.formData).map(function (k) {
                    return encodeURIComponent(k) + '=' + encodeURIComponent(request.requestBody.formData[k])
                }).join('&')
                headersStr += "\n\n" + params
            } else if (request?.requestBody?.raw) {
                // let arr = new Uint8Array(request.requestBody.raw[0].bytes)
                // let params = String.fromCharCode.apply(String, arr)
                headersStr += "\n\n" + request.requestBody.raw
            }

            $form.form('set values', {
                'request': headersStr,
            })
            $(document).trigger("parse_request", formId)

        }
    })

    $(document).on("reset_form", function (e, formId) {
        let $form = $('#' + formId + ' #request_form')
        $form.form('clear')
        $form.form('set values', { 'request_method': 'GET', 'request_protocol': 'HTTP', 'request_redirect': true })

        $form.form({
            inline: true,
            keyboardShortcuts: false,
            fields: {
                request_method: {
                    identifier: 'request_method',
                    rules: [{ type: 'empty' }]
                },
                request_protocol: {
                    identifier: 'request_protocol',
                    rules: [{ type: 'empty' }]
                },
                request_url: {
                    identifier: 'request_url',
                    rules: [{
                        prompt: 'URL is required',
                        type: 'regExp',
                        value: /^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/i,
                    }]
                },
                request_port: {
                    identifier: 'request_port',
                    rules: [{ type: 'integer', prompt: 'Port should be an integer value', }]
                }
            }
        })
    })

    $(document).on("parse_request", function (e, formId) {
        waiting = true
        let $form = $('#' + formId + ' #request_form')
        let values = $form.form('get values')
        try {
            if (values['request'])
                controller.parseRawRequest(values).then(function (schema) {
                    $form.form('set value', 'request_method', schema.request.method)
                    $form.form('set value', 'request_url', schema.request.url)
                    $form.form('set value', 'request_protocol', schema.request.protocol.replace(":", ""))
                    $form.form('set value', 'request', schema.request.asString)
                    waiting = false
                })

        } catch (e) {
            $('#traffic_error_message').text(e)
            $('.mini.modal').modal('show')
        }

    })

    $(document).on("update_raw_request", function (e, formId) {
        if (waiting) return
        let $form = $('#' + formId + ' #request_form')
        let values = $form.form('get values')
        if (values.request == "" && values.request_url == "") return
        try {
            controller.updateRawRequest(values).then(function (schema) {
                $form.form('set value', 'request_method', schema.request.method)
                $form.form('set value', 'request_url', schema.request.url)
                $form.form('set value', 'request_protocol', schema.request.protocol.replace(":", ""))
                $form.form('set value', 'request', schema.request.asString)
            })
        } catch (e) {
            $('#traffic_error_message').text(e)
            $('.mini.modal').modal('show')
        }
    })

    $(document).on("send_request", function (e, formId) {
        let schema = {}
        let $form = $('#' + formId + ' #request_form')
        $form.form('set value', 'response_headers', '')
        $form.form('set value', 'response_body', '')
        $form.form('validate form')

        if ($form.form('is valid')) {
            let values = $form.form('get values')
            controller.parseRawRequest(values).then(function (schema) {
                schema.request.followRedirect = values.request_redirect == 'on' ? true : false
                controller.sendRequest(schema).then((result) => {
                    $form.form('set value', 'response_headers', result.headers)
                    $form.form('set value', 'response_body', result.body)
                }).catch(function (error) {
                    $form.form('set value', 'response_headers', error.message)
                })
            })
        }
    })



    $('.rbsettings').on('click', function () {
        $('.request_forms_container').hide("slow")
        $('.request_settings_container').show("slow")
    })

    $('#closesettings').on('click', function () {
        $('.request_settings_container').hide("slow")
        $('.request_forms_container').show("slow")
    })

    $('#add_request').on('click', function () {
        let lastId = 'tab_0', lastIndex = 0, newIndex = 0
        $('#content .request_tab').each(function (i, obj) {
            lastId = $(obj).attr('id')
            let index = parseInt($(obj).attr('index'))
            lastIndex = index > lastIndex ? index : lastIndex;
            $(obj).removeClass('active')
        })
        newIndex = lastIndex + 1

        $("#content .item.active").removeClass('active')
        $(".tab.segment.active").removeClass('active')

        let newItem = '<a class="item active request_tab" ' +
            'index="' + newIndex + '" id="tab_' + newIndex + '" data-tab="tab_' + newIndex + '"><span>Request</span><i class="window close icon"></i></a>'
        $('#' + lastId).after(newItem)

        $("#request_" + lastIndex).after($("#request_0").
            clone().
            attr('id', 'request_' + newIndex).
            attr('index', newIndex).
            attr('data-tab', 'tab_' + newIndex).
            addClass('active'))

        $(document).trigger("reset_form", 'request_' + newIndex)
        $('.menu .item').tab()
    })

    $(document).on("submit", ".tiny.form", function (e) {
        e.preventDefault()
        return false
    })

    $(document).on("click", ".reset", function () {
        $(document).trigger("reset_form", $(this).closest('.ui.tab.active').attr('id'))
    })

    $(document).on("click", ".send", function () {
        $(document).trigger("send_request", $(this).closest('.ui.tab.active').attr('id'))
    })

    $(document).on("click", ".window.close.icon", function () {
        $('.ui.inverted.dimmer').addClass('active')
        $(document).trigger("remove_tab", $(this).parent().attr('index'))
        setTimeout(function () {
            $('.ui.inverted.dimmer').removeClass('active')
        }, 200)
    })

    $(document).on("dblclick", ".request_tab span", function () {
        $(this).attr('contentEditable', true)
        $(this).trigger('focus')
    })

    $(document).on("blur", ".request_tab span", function () {
        $(this).attr('contentEditable', false)
    })

    $(document).on("click", ".showHtml", function () {
        let formId = $(this).closest('.ui.tab.active').attr('id'),
            $form = $('#' + formId + ' #request_form'),
            values = $form.form('get values')
        let htmlString = $(this).closest('.response_view').find('[name="response_body"]').val()
        controller.parseRawRequest(values).then(function (schema) {
            let baseURI = schema.request.protocol + "//" + schema.request.host + "/"
            htmlString = htmlString.replace(/<(head)(.+)?>/, "<$1$2><base href='" + baseURI + "' />")
            let dataBase64 = 'data:text/html;base64,' + btoa(unescape(encodeURIComponent(htmlString)))
            let dataUri = 'data:text/html,' + encodeURIComponent(htmlString)


            let blob = new Blob([unescape(encodeURIComponent(htmlString))], { type: 'text/html' })
            let srcData = URL.createObjectURL(blob)

            $('#dialogResponseHtml').modal('show')
            $('#dialogResponseHtmlFrame').prop('src', dataBase64)

            // var win = window.open();
            // win.document.write('<iframe src="' + srcData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');

            // //var newWindow = window.open("data:text/html,<script>alert('hi');</script>");
        })
        return false
    })

    $(document).on('change', "[name=request_method], [name=request_protocol], [name=request_url]", function (e) {
        if (e.target.value != "")
            $(document).trigger("update_raw_request", $(this).closest('.ui.tab.active').attr('id'))
    })

    $(document).on('change', "[name=request]", function (e) {
        if (e.target.value != "")
            $(document).trigger("parse_request", $(this).closest('.ui.tab.active').attr('id'))
    })

    $(document).on("remove_tab", function (e, index) {
        $('[data-tab=tab_' + index + ']').remove()
        $(".ui.tab.active").removeClass('active')
        $(".request_tab").removeClass('active')
        $('[data-tab=tab_0]').addClass('active')
        $('#request_0').addClass('active')
    })

    var addNewRequest = function () {

        var lastId = 'tab_0',
            lastIndex = 0,
            newIndex = 0;
        $('#tabMenuId .item').each(function (i, obj) {
            lastId = $(obj).attr('id');
            var i = parseInt($(obj).attr('index'));
            lastIndex = i > lastIndex ? i : lastIndex;
            $(obj).removeClass('active');
        });
        newIndex = lastIndex + 1;

        $("#tabMenuId .item.active").removeClass('active');
        $(".tab.segment.active").removeClass('active');

        var newItem = '<a class="item active request_tab" ' +
            'index="' + newIndex + '" id="tab_' + newIndex + '" data-tab="tab_' + newIndex + '"><span>Request</span><i class="window close icon"></i></a>';
        $('#' + lastId).after(newItem);

        $("#request_" + lastIndex).after($("#request_0").
            clone().
            attr('id', 'request_' + newIndex).
            attr('data-tab', 'tab_' + newIndex).
            addClass('active'));

        $(document).trigger("initEvents", newIndex);
        $(document).trigger("resetForm", 'request_' + newIndex);
        $('.menu .item').tab();
        return newIndex;
    }


    let waiting = false

    $(document).trigger("reset_form", 'request_0')

    let params = new URLSearchParams(window.location.search)
    if (params.has('requestDetails')) {
        let request = JSON.parse(atob(params.get('requestDetails')))
        $(document).trigger("init_request", [request, "request_0"])
    } else if (params.has('validateRequest')) {
        let data = decodeURIComponent(params.get('validateRequest'))
        let requests = atob(data).split('#H#G#F#E#D#C#B#A#')
        for (let i = 0; i < requests.length; i++) {
            if (i > 0) $('#add_request').trigger('click')
        }
        for (let i = 0; i < requests.length; i++) {
            let r_r = requests[i].split('#A#B#C#D#E#F#G#H#')
            let $form = $('#request_' + i + ' #request_form')
            $form.form('set values', {
                'request': r_r[0].trim()
            })
            $('#tab_' + i).find('span').text('Attack #' + (i + 1))
            $(document).trigger("parse_request", 'request_' + i)
        }

    }


   

})