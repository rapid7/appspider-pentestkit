/* Author: Denis Podgurskii */

jQuery(function () {

    const editor = SwaggerEditorBundle({
        dom_id: '#swaggerui',
        layout: 'StandaloneLayout',
        presets: [
            SwaggerEditorStandalonePreset
        ]
    })

    window.editor = editor

/*
    browser.tabs.query({ 'active': true, 'lastFocusedWindow': true, 'currentWindow': true }).then(function (tabs) {
        $(document).trigger("open_swagger", tabs[0].url)
    })


    $(document).on("open_swagger", function (e, specUrl) {
        let xhr = new XMLHttpRequest()
        xhr.open("GET", specUrl, true)
        //$('#no_swagger').removeClass("display")
        xhr.onreadystatechange = function () {
            $('.inverted.dimmer').removeClass("active")
            let err = false
            try {
                let specResponse = xhr.responseText
                if (specUrl.includes('.yaml') || specUrl.includes('.yml'))
                    specResponse = jsyaml.load(xhr.responseText)
                else
                    specResponse = JSON.parse(xhr.responseText)

                let swaggerUI
                err = false
                swaggerUI = SwaggerUIBundle({
                    url: specUrl,
                    spec: specResponse,
                    dom_id: '#swaggerui',
                    presets: [
                        SwaggerUIBundle.presets.apis,
                        SwaggerUIBundle.SwaggerUIStandalonePreset
                    ]
                })
                err = false 
                document.getElementById('swagger_url').value = specUrl
            } catch (e) {
                err = true
            }

            //setTimeout(function () { if (err) $('#no_swagger').addClass("display") }, 500)
        }

        xhr.send(null)
    })

    $(document).on("click", ".open_swagger", function (e) {
        $.fn.form.settings.templates.prompt = function (errors) {
            return $('<div/>')
                .addClass('ui red pointing prompt label')
                .html(errors[0])
                ;
        }

        let $form = $('#swagger_form')
        $form.form({
            inline: true,
            fields: {
                swagger_url: {
                    identifier: 'swagger_url',
                    rules: [{
                        prompt: 'URL is required in the format http://example.com/swagger.json or file:///example/swagger.yaml',
                        type: 'regExp',
                        value: /^((http|https|file):\/\/){1}(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])?(:+[0-9]+)?([\/\?]{1}.*)?$/i,
                    }]
                }
            }
        })

        $form.form('validate form')
        if (!$form.form('is valid')) return
        $('.inverted.dimmer').addClass("active")
        let specUrl = $form.form('get value', 'swagger_url')
        $(document).trigger("open_swagger", specUrl)

    })

    $(document).on("submit", "#swagger_form", function (e) {
        e.preventDefault()
        return false
    })
    */

})
