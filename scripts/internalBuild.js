const fs = require('fs');

console.log('Building internal plugin')

const {
    PTK_MANIFEST_FILENAME,
    INTERNAL_MANIFEST_FILENAME,
    MAIN_MANIFEST_FILENAME,
    MANIFEST_LOCATION,
    POLLY_FILL_DIR
} = require('./consts');

// Make browser-polyfill folder
fs.mkdir(`${process.cwd()}${POLLY_FILL_DIR}`, { recursive: true }, err => {
    if (err) {
        console.error(err);
        return;
    }

    console.log(`Created folder: ${POLLY_FILL_DIR}`);

    console.log('Copying browser polly fill JS files');

    fs.copyFile(
        `${process.cwd()}/node_modules/webextension-polyfill/dist/browser-polyfill.min.js`,
        `${process.cwd()}/src/extension/packages/browser-polyfill/browser-polyfill.min.js`,
        err => {
            if (err) {
                console.error(err);
                return;
            }

            console.log('Polly fill file copied');

            console.log(`Changing ${MAIN_MANIFEST_FILENAME} to use ${INTERNAL_MANIFEST_FILENAME}`);
            console.log(`Backing up current ${MAIN_MANIFEST_FILENAME} to ${PTK_MANIFEST_FILENAME}`);

            fs.copyFile(
                `${MANIFEST_LOCATION}${MAIN_MANIFEST_FILENAME}`,
                `${MANIFEST_LOCATION}${PTK_MANIFEST_FILENAME}`,
                err => {
                    if (err) {
                        console.error(err);
                        return
                    }

                    console.log(`${MAIN_MANIFEST_FILENAME} updated`);

                    console.log(`Making ${INTERNAL_MANIFEST_FILENAME} the main ${MAIN_MANIFEST_FILENAME}`)

                    fs.copyFile(
                        `${MANIFEST_LOCATION}${INTERNAL_MANIFEST_FILENAME}`,
                        `${MANIFEST_LOCATION}${MAIN_MANIFEST_FILENAME}`,
                        err => {
                            if (err) {
                                console.error(err);
                                return
                            }

                            console.log(`${MAIN_MANIFEST_FILENAME} updated`);

                            console.log(`Making ${INTERNAL_MANIFEST_FILENAME}`)
                    })
            })
        }
    )
});
