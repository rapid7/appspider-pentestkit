/* Author: Denis Podgurskii */
'use strict';

window.addEventListener("message", function(event) {
    if(event.data && event.data.channel == "ptkWSToContent"){
        chrome.runtime.sendMessage({ channel: "ptkContentToPopup", type: "websocket", data: event.data });
    }
});

chrome.runtime.onMessage.addListener(
    function(request, sender, sendResponse) {

        if (request.channel == "ptkPopupToContent" && request.type == "init") {

            console.log("init");
            var meta = document.createElement('meta');
            meta.id = 'pentestkitMetaId';
            meta.content = request.responseHeaders;
            (document.head || document.documentElement).appendChild(meta);

            var sDict = document.createElement('script');
            sDict.onload = function() {
                var sDetector = document.createElement('script');
                sDetector.src = chrome.extension.getURL(request.detector);
                sDetector.id = "pentestkitDetectorId";
                (document.head || document.documentElement).appendChild(sDetector);
            };
            sDict.src = chrome.extension.getURL(request.dictionary);
            sDict.id = "pentestkitDictionaryId";
            (document.head || document.documentElement).appendChild(sDict);

            meta.addEventListener('ready', function(event) {

                var s = document.getElementById("pentestkitDictionaryId");
                s.parentNode.removeChild(s);
                s = document.getElementById("pentestkitDetectorId");
                s.parentNode.removeChild(s);
                var m = document.getElementById("pentestkitMetaId");
                m.parentNode.removeChild(m);

                // HTML
                var clientHtml = new XMLSerializer().serializeToString(document).split('\n');

                clientHtml = clientHtml
                    .slice(0, 1000).concat(clientHtml.slice(clientHtml.length - 1000))
                    .map(line => line.substring(0, 1000))
                    .join('\n');

                // Scripts
                const clientScripts = Array.prototype.slice
                    .apply(document.scripts)
                    .filter(script => script.src)
                    .map(script => script.src)
                    .filter(script => script.indexOf('data:text/javascript;') !== 0);

                chrome.runtime.sendMessage({ channel: "ptkContentToPopup", type: "complete", apps: meta.content, html: clientHtml, scripts: clientScripts });

            });

            ///////////////////////////////////
            var ws = document.getElementById("pentestkitWSId");
            if (!ws) {
                var script = document.createElement('script');
                script.textContent = "var extensionId = " + JSON.stringify(chrome.runtime.id);
                (document.head || document.documentElement).appendChild(script);
                script.parentNode.removeChild(script);

                var sWs = document.createElement('script');
                sWs.src = chrome.extension.getURL("assets/js/ws.js");
                sWs.id = "pentestkitWSId";
                (document.head || document.documentElement).appendChild(sWs);
            }
        }



        if (request.channel == 'ptkBackgroundToRecorder') {
            //The recorder is a singleton -- there is no real reason to have more than
            //one instance, and many of its methods are event handlers which need a
            //stable reference to the instance.
            recorder = new TestRecorder.Recorder();
            recorder.logfunc = function(msg) { console.log(msg); };
            recorder.start();

            if (request.action == 'openRecorderURL') {
                recorder.open(request.url);
                window.location.href = request.url;
            }
            if (request.action == 'initRecorder') {
                if (debug) {
                    console.log('initRecorder');
                    console.log(request.items);
                }
                recorder.init(request.items);
            }
        }
    });