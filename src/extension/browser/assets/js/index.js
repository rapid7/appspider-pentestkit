/* Author: Denis Podgurskii */
import { ptk_controller_index } from "./controller/index.js"
const controller = new ptk_controller_index()

jQuery(function () {
    

    $('.item.clean').on('click', function () {
        controller.clear().then(function () {
            bindTable('#tbl_technologies', { "data": [] })
            bindTable('#tbl_owasp', { "data": [] })
            bindTable('#tbl_frames', { "data": [] })
        })
    })

    $('.item.restart').on('click', function () {
        controller.restart().then(function () {
            bindTable('#tbl_technologies', { "data": [] })
            bindTable('#tbl_owasp', { "data": [] })
            bindTable('#tbl_frames', { "data": [] })
        })
    })

    $("input[name='deactivate_capturing']").on('change', e => {
        let $form = $('#dashboard_form'), values = $form.form('get values')
        if (values['deactivate_capturing'] == 'on')
            controller.deactivate()
        else
            controller.activate()
    })


    $(document).on("click", ".request_details", function () {
        let table = $(this).closest('table').DataTable(),
            tr = $(this).closest('tr'),
            row = table.row(tr),
            values = table.row($(this).parents('tr')).data()
        controller.getRequest(values[3], values[2], values[1]).then(function (response) {
            window.location.href = "requestbuilder.html?requestDetails=" + btoa(JSON.stringify(response))
        })
    })

    $(document).on("click", ".rattacker", function () {
        let table = $(this).closest('table').DataTable(),
            tr = $(this).closest('tr'),
            row = table.row(tr),
            values = table.row($(this).parents('tr')).data()
        controller.getRequest(values[3], values[2], values[1]).then(function (response) {
            window.location.href = "rattacker.html?requestDetails=" + btoa(JSON.stringify(response))
        })
    })

    $(document).on("click", "#download_domain_list", function () {
        let data = controller.domains
        if (data != null) {
            let blob = new Blob([data.join("\r\n")], { type: 'text/plain' })
            let downloadLink = document.createElement("a")
            downloadLink.download = "PTK_domains_" + (new URL(controller.url)).hostname + ".txt"
            downloadLink.href = window.URL.createObjectURL(blob)
            downloadLink.click()
        }
    })

    $(document).on("click", "#download_url_list", function () {
        let data = controller.urls
        if (data != null) {
            let blob = new Blob([data.join("\r\n")], { type: 'text/plain' })
            let downloadLink = document.createElement("a")
            downloadLink.download = "PTK_urls_" + (new URL(controller.url)).hostname + ".txt"
            downloadLink.href = window.URL.createObjectURL(blob)
            downloadLink.click()
        }
    })

    $('#main').dimmer('show')
    bindAll()

})

/* Helpers */

function bindAll() {

    
    controller.init().then(function (result) {
        
        bindInfo()
        bindTechnologies()
        bindOWASP()
        bindFrames()
        $('#main').dimmer('hide')
    }).catch(e => bindInfo())
}

function bindInfo() {
    let $form = $('#dashboard_form')
    if (controller.isTabsCapturingActive) {
        $form.form('set value', 'deactivate_capturing', false)
        if (controller.wappalyzer) {
            $('#dashboard_message_text').text(controller.url)
        } else {
            $('#dashboard_message_text').html('Active tab not initialized. Reload the tab and re-open the extension<i class="exclamation red circle large icon"></i>')
           
        }
    } else {
        $form.form('set value', 'deactivate_capturing', true)
        $('#dashboard_message_text').html(`Tabs capturing disabled. Allow tabs capturing and reload the tab<i class="exclamation red  circle large icon"></i>`)
    }
}

function bindTechnologies() {
    let dt = new Array()
    if (controller.technologies)
        Object.values(controller.technologies).forEach(item => {
            let link = '<a target="_blank" href="https://www.cvedetails.com/google-search-results.php?q=' + item.name + '+' + item.version + '"><i class="external alternate icon"></i></a>'
            dt.push([item.name, item.version, link])
        })
    let params = { "data": dt, "columns": [{ width: "50%" }, { width: "40%" }, { width: "10%" }] }
    bindTable('#tbl_technologies', params)

}

function bindOWASP() {
    let dt = controller.findings ? controller.findings : new Array()
    let params = { "data": dt, "columns": [{ width: "30%" }, { width: "70%" }] }
    bindTable('#tbl_owasp', params)
}

function bindFrames() {
    let dt = controller.frames?.length ? controller.frames : new Array()
    dt = dt.sort(function (a, b) {
        if (a[2] < b[2]) { return 1 }
        if (a[2] > b[2]) { return -1 }
        return 0
    })
    //move to jquery stuff
    let params = {
        "data": dt,
        "columns": [{
            render: function (data, type, row) {
                return '<i class="expandchild plus square icon"></i>'
            },
            "className": "expandbtn"
        }, { "visible": false }, { title: "Frame" }, { title: "Url" }, { title: "IP", class: "frameIP" }]
    }
    let table = bindTable('#tbl_frames', params)

    $('.expandchild.plus.icon').on('click', function () {
        let tr = $(this).closest('tr'), row = table.row(tr), values = table.row($(this).parents('tr')).data()
        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide()
            $(this).removeClass('shown minus')
            $(this).addClass('shown plus')
        } else {
            // Open this row
            row.child(
                `<div style="padding-left: 45px">
                        <table class="ui celled table stackable small fullwidth" id="tbl_frame_` + values[1] + `" > 
                            <thead>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>`
            ).show()
            $(this).removeClass('shown plus')
            $(this).addClass('shown minus')
            bindRequests(values[1])
        }
    })
    $('.expandchild.plus.icon:first').trigger('click')
}

function bindRequests(index) {
    let dt = new Array()
    controller.getFrame(index).then(function (frame) {
        let i = 0
        Object.values(frame).forEach(item => {
            let request = item[1][0], key = item[0]
            let u = new URL(request.url)
            dt.push(['', i, key, request.frameId, u.hostname.substr(0, 40), u.pathname.substr(0, 40), request.method, request.statusCode ? request.statusCode : '',
                request.type, request.ip ? request.ip : ''
            ])
            i++
        })
        let params = {
            "data": dt,
            "columns": [{
                render: function (data, type, row) {
                    return `<div style="min-width:50px"><i class=" large icon link request_details" data-position="bottom left" title="Send to request builder" style="margin:0px"><img src="assets/images/http.png"></i>
                    <i class=" large icon link rattacker" data-position="bottom left" title="Send to R-Attacker" style="margin: 0px;"><img src="assets/images/rat.png"></i></div>`
                }
            }, { "visible": false }, { "visible": false }, { "visible": false }, { title: "Host" }, { title: "Path" }, { title: "Method" }, { title: "Status" }, { title: "Type" }, { title: "IP" }
            ]
        }
        let tableId = '#tbl_frame_' + index
        let table = bindTable(tableId, params)

        table.columns().flatten().each(function (colIdx) {
            let title = $(table.column(colIdx).header()).text()
            if (title) {
                let select = $('<br/><input type="text" placeholder="Search ' + title + '" />')
                    .appendTo(
                        table.column(colIdx).header()
                    )
                    .on('keyup change clear', function () {
                        table
                            .column(colIdx)
                            .search($(this).val())
                            .draw()
                    })
            }
        })
        $('.tooltip').popup()

    })
}


/* Chrome runtime events handlers */
browser.runtime.onMessage.addListener(function (message, sender, sendResponse) {

    if (message.channel == "ptk_background2popup_tabs") {
        if (message.type == "active tab changed" && $("input[name='reload_on_active']").parent().checkbox('is checked')) {
            bindAll()
        }
        else if (message.type == "requests source resized") {
            if (controller.waiting) return
            controller.waiting = true
            setTimeout(function () {
                controller.getAllFrames().then(function () {
                    controller.waiting = false
                    bindFrames()
                })
            }, 500)
        }
    }
})

