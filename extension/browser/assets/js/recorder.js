/* Author: Denis Podgurskii */
'use strict';

$(document).ready(function() {
    var editor = CodeMirror.fromTextArea(document.getElementById('macro_text'), {
        lineNumbers: true,
        mode: "application/xml",
        indentUnit: 6
    });
    editor.setSize('auto', '500px');


    var $form = $('#macro_form');
    $form.form({
        fields: {
            macro_url: {
                identifier: 'macro_url',
                rules: [{
                    type: 'regExp',
                    value: /^((http|https):\/\/){1}(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])?(:+[0-9]+)?([\/\?]{1}.*)?$/i,
                }]
            },
            min_duration: {
                identifier: 'min_duration',
                rules: [{
                    type: 'integer',
                    prompt: 'Please enter an integer value'
                }]
            },
        }
    });
    $form.form('set value', 'element_path', bgProxy.Recorder.elementPath);
    $form.form('set value', 'min_duration', bgProxy.Recorder.minDuration);

    chrome.tabs.query({
        active: true,
        lastFocusedWindow: true
    }, function(tabs) {
        var tab = tabs[0];
        $form.form('set value', 'macro_url', tab.url);
    });


    $('.start').on('click', function() {
        $form.form('validate form');
        if (!$form.form('is valid')) return;

        bgProxy.Recorder.cleanCookie = false;
        var values = $form.form('get values');
        var message = {
            channel: 'ptkRecorderToBackground',
            data: {
                function: 'start',
                start_url: values['macro_url']
            }
        };
        chrome.runtime.sendMessage(message);
    });

    $('.start_clean_cookie').on('click', function() {
        $form.form('validate form');
        if (!$form.form('is valid')) return;

        bgProxy.Recorder.cleanCookie = true;
        var values = $form.form('get values');
        var message = {
            channel: 'ptkRecorderToBackground',
            data: {
                function: 'start',
                start_url: values['macro_url']
            }
        };
        chrome.runtime.sendMessage(message);
    });


    $('.macro_export').on('click', function() {
        var $form = $('#macro_form');
        $form.form({
            fields: {
                min_duration: {
                    identifier: 'min_duration',
                    rules: [{
                        type: 'integer',
                        prompt: 'Please enter an integer value'
                    }]
                },
            }
        });
        if (!$form.form('is valid')) return;

        var values = $form.form('get values');
        var message = {
            channel: 'ptkRecorderToBackground',
            data: {
                function: 'export'
            }
        };
        values['useEncryption'] = false;
        chrome.runtime.sendMessage(message, function(response) {
            var res = Exporter.renderXml(response, values);
            $form.form('set value', 'macro_text', res);
            editor.setOption("mode", "application/xml");
            editor.setValue(res);
        });

    });


    $('.traffic_export').on('click', function() {
        var harLog = Exporter.renderHar(bgProxy.Recorder.requests);
        if (harLog) {
            $form.form('set value', 'macro_text', JSON.stringify(harLog, null, 2));
            editor.setOption("mode", "javascript/json");
            editor.setValue(JSON.stringify(harLog, null, 2));
        }
    });


    $('.resetmacro').on('click', function() {
        $form.form('set value', 'macro_text', '');
        editor.setValue('');
        var message = {
            channel: 'ptkRecorderToBackground',
            data: {
                function: 'reset'
            }
        };
        chrome.runtime.sendMessage(message);
    });

    $("input[name='element_path']").on('change', function() {
        bgProxy.Recorder.elementPath = this.value;
    });

    $("input[name='min_duration']").on('change', function() {

    });


    $('.macro_download').on('click', function() {
        $('.macro_export').trigger('click');
        setTimeout(function() {
            var blob = new Blob([editor.getValue()], { type: 'text/plain' });
            var values = $form.form('get values');
            var fName = (values['macro_filename'] != "") ? values['macro_filename'] + ".rec" : "PenTestKitMacro.rec";

            var downloadLink = document.createElement("a");
            downloadLink.download = fName;
            downloadLink.innerHTML = "Download File";
            downloadLink.href = window.URL.createObjectURL(blob);
            downloadLink.click();
        }, 100);
    });

    $('.traffic_download').on('click', function() {
        $('.traffic_export').trigger('click');
        var blob = new Blob([editor.getValue()], { type: 'text/plain' });
        var values = $form.form('get values');
        var fName = (values['macro_filename'] != "") ? values['macro_filename'] + ".har" : "PenTestKitMacro.har";

        var downloadLink = document.createElement("a");
        downloadLink.download = fName;
        downloadLink.innerHTML = "Download File";
        downloadLink.href = window.URL.createObjectURL(blob);
        downloadLink.click();
    });

});